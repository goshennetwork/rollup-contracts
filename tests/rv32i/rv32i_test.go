package rv32i

import (
	"encoding/binary"
	"encoding/hex"
	"math/big"
	"path/filepath"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/math"
	"github.com/ethereum/go-ethereum/core/vm"
	"github.com/ethereum/go-ethereum/ethdb/memorydb"
	"github.com/ethereum/go-ethereum/trie"

	"github.com/laizy/web3"
	"github.com/laizy/web3/abi"
	"github.com/laizy/web3/hardhat"
	"github.com/ontology-layer-2/rollup-contracts/tests"
)

func TestT(t *testing.T) {

	_, err := hex.DecodeString("608060405234801561001057600080fd5b50600436106100ea5760003560e01c80638f6a85ff1161008c578063ca89c01811610066578063ca89c01814610207578063d7de86251461021a578063e6a755d21461022d578063ec565e9d1461024057600080fd5b80638f6a85ff146101b55780639ff75515146101c8578063c577a315146101f457600080fd5b806338453b95116100c857806338453b95146101695780636a3399ed1461017c578063840a1d7d1461018f57806386118de4146101a257600080fd5b8063044b328b146100ef5780630ea894ec146101205780633229f4d214610141575b600080fd5b6101026100fd3660046133c3565b61026c565b6040516001600160e01b031990911681526020015b60405180910390f35b61013361012e3660046133f3565b610282565b604051908152602001610117565b61015461014f3660046133c3565b610298565b60405163ffffffff9091168152602001610117565b610133610177366004613442565b610322565b61013361018a366004613442565b610330565b61013361019d3660046133c3565b61033e565b6101336101b036600461348f565b61034b565b6101026101c33660046133c3565b610359565b6101db6101d63660046133c3565b6103e3565b6040516001600160f81b03199091168152602001610117565b6101336102023660046134c6565b6103f0565b6101546102153660046133c3565b6103fe565b61013361022836600461348f565b61040b565b61013361023b3660046134fe565b610419565b61025361024e3660046133c3565b610427565b6040516001600160f01b03199091168152602001610117565b6000610279818484610434565b90505b92915050565b6000610290818585856104bb565b949350505050565b604051637e1aadcb60e11b81526000600482018190526024820184905263ffffffff831660448301529073__$4353aa6cf5ff3a0c45b8f9fa5649b0430c$__9063fc355b9690606401602060405180830381865af41580156102fe573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102799190613542565b600061029081858585610523565b600061029081858585610542565b6000610279818484610558565b6000610290818585856105c3565b6040516312d455a160e21b81526000600482018190526024820184905263ffffffff831660448301529073__$4353aa6cf5ff3a0c45b8f9fa5649b0430c$__90634b51568490606401602060405180830381865af41580156103bf573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610279919061355f565b60006102798184846105f3565b600061029081858585610639565b6000610279818484610686565b60006102908185858561069f565b6000610290818585856106f5565b6000610279818484610750565b600060038216156104825760405162461bcd60e51b81526020600482015260136024820152723737b716b0b634b3b732b21036b2b690383a3960691b60448201526064015b60405180910390fd5b60008061049886610492866107b8565b876107ec565b91509150816104a85760006104b1565b6104b181610926565b9695505050505050565b6000600383166104cb8185613592565b935060006104da878787610434565b905060006104e98360086135b7565b6001600160f81b031963ffffffff821681811c19948516918816901c17929091506105168989898661069f565b9998505050505050505050565b600061053985858561053486610980565b61069f565b95945050505050565b600061053985858561055386610980565b6105c3565b6000806105666020846135e3565b925060005b60088163ffffffff1610156105ba57610585600485613592565b9350602082901c9150610599868686610434565b6001600160e01b03191691909117906105b36001826135e3565b905061056b565b50949350505050565b600063ffffffff83166105d7575082610290565b610539856105e485610994565b6105ed856109c4565b876109e2565b6000600382168161060e86866106098588613592565b610434565b905061061b8260086135b7565b63ffffffff16816001600160e01b031916901b925050509392505050565b6000805b60208163ffffffff16101561067c57610661868661065b84886135e3565b8661069f565b945060209290921b916106756004826135e3565b905061063d565b5092949350505050565b600080610694858585610434565b905061053981610ab4565b600060038316156106e85760405162461bcd60e51b81526020600482015260136024820152723737b716b0b634b3b732b21036b2b690383a3960691b6044820152606401610479565b610539856105e4856107b8565b6000600383166107058185613592565b93506000610714878787610434565b905060006107238360086135b7565b6001600160f01b031963ffffffff821681811c19948516918816901c17929091506105168989898661069f565b60006003808316908114156107a75760405162461bcd60e51b815260206004820152601860248201527f646174612063726f737320346279746520626f756e64727900000000000000006044820152606401610479565b600061060e86866106098588613592565b6040516001600160e01b031960e083901b1660208201526060906024015b6040516020818303038152906040529050919050565b6040805180820190915260018152600160ff1b602090910152600060607f56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421831415610849575050604080516020810190915260008082529061091e565b600061085485610ac2565b90506000806000806108678a868a610bfd565b81519397509195509350915015808061087d5750815b6108c95760405162461bcd60e51b815260206004820152601a60248201527f50726f76696465642070726f6f6620697320696e76616c69642e0000000000006044820152606401610479565b6000816108e55760405180602001604052806000815250610911565b610911866108f460018861360b565b8151811061090457610904613622565b60200260200101516110e8565b9198509096505050505050505b935093915050565b6000815160041461096e5760405162461bcd60e51b815260206004820152601260248201527177726f6e67206c656e6774682076616c756560701b6044820152606401610479565b60006109798361123a565b9392505050565b600061098b82611260565b60e01b92915050565b60606109a1600183613592565b60f81b6040516020016107d691906001600160f81b031991909116815260010190565b6040516001600160e01b0319821660208201526060906024016107d6565b6000806109ee85610ac2565b6040805180820190915260018152600160ff1b60209091015290507f56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421831415610a72576000610a3d82866112c8565b51805160208083019182206000818152918b9052604090912083519394509092610a679290613315565b509250610290915050565b6000806000610a82898588610bfd565b509250925092506000610a998a858588868d611379565b9050610aa68a8287611800565b9a9950505050505050505050565b600061027c8260e01c611260565b6060600082516002610ad49190613638565b67ffffffffffffffff811115610aec57610aec613657565b6040519080825280601f01601f191660200182016040528015610b16576020820181803683370190505b50905060005b8351811015610bf6576004848281518110610b3957610b39613622565b01602001516001600160f81b031916901c82610b56836002613638565b81518110610b6657610b66613622565b60200101906001600160f81b031916908160001a9053506010848281518110610b9157610b91613622565b0160200151610ba3919060f81c613683565b60f81b82610bb2836002613638565b610bbd9060016136a5565b81518110610bcd57610bcd613622565b60200101906001600160f81b031916908160001a90535080610bee816136bd565b915050610b1c565b5092915050565b6060600060606000806000905086516001610c1891906136a5565b67ffffffffffffffff811115610c3057610c30613657565b604051908082528060200260200182016040528015610c7557816020015b6040805180820190915260608082526020820152815260200190600190039081610c4e5790505b5094506000869050600060209050600080610ca3604051806040016040528060608152602001606081525090565b60005b8a518110156110bc57600160ff1b861415610cc0576110bc565b60208510610cd957610cd28e876119d7565b9150610d19565b610d16610d11610d0c88604051602001610cf591815260200190565b604051602081830303815290604052600089611b25565b611b6a565b611bd3565b91505b818b8881518110610d2c57610d2c613622565b6020908102919091010152610d4183856136a5565b9350610d4e6001886136a5565b965083610da657815180516020909101208614610da15760405162461bcd60e51b8152602060048201526011602482015270092dcecc2d8d2c840e4dedee840d0c2e6d607b1b6044820152606401610479565b610e63565b815151602011610e0857815180516020909101208614610da15760405162461bcd60e51b815260206004820152601b60248201527f496e76616c6964206c6172676520696e7465726e616c206861736800000000006044820152606401610479565b85610e16836000015161123a565b14610e635760405162461bcd60e51b815260206004820152601a60248201527f496e76616c696420696e7465726e616c206e6f646520686173680000000000006044820152606401610479565b610e6f601060016136a5565b8260200151511415610eec578c51841415610e89576110bc565b60008d8581518110610e9d57610e9d613622565b602001015160f81c60f81b60f81c9050600083602001518260ff1681518110610ec857610ec8613622565b60200260200101519050610edb81611c09565b9098509650600194506110aa915050565b6002826020015151141561106e576000610f09610d0c8f87611c4a565b90506000610f1684611c70565b9050600081600081518110610f2d57610f2d613622565b016020015160f81c90506000610f44600283613683565b610f4f9060026136d8565b90506000610f63610d0c858460ff16611c4a565b90506000610f718287611ca1565b905060ff841660021480610f88575060ff84166003145b15610fc257808251148015610f9d5750808651145b15610faf57610fac818b6136a5565b99505b50600160ff1b9a506110bc945050505050565b60ff84161580610fd5575060ff84166001145b1561102e5781518114610ff55750600160ff1b9a506110bc945050505050565b61101c886020015160018151811061100f5761100f613622565b6020026020010151611c09565b909c509a5097506110aa945050505050565b60405162461bcd60e51b8152602060048201526015602482015274756e6b6e6f776e207072656669786564206e6f646560581b6044820152606401610479565b60405162461bcd60e51b8152602060048201526011602482015270756e6b6e6f776e206e6f6465207479706560781b6044820152606401610479565b806110b4816136bd565b915050610ca6565b506110ca610d0c8d85611c4a565b9598509496505050600160ff1b919091149250505093509350935093565b602081015180516060916000916111019060019061360b565b8151811061111157611111613622565b60200260200101519050600080600061112984611d1d565b919450925090506000816001811115611144576111446136fb565b1415611175576104b1604051806040016040528084815260200185876020015161116e91906136a5565b9052611b6a565b6001816001811115611189576111896136fb565b14156111fe5783516020116111d95760405162461bcd60e51b81526020600482015260166024820152751898590817d9d95d139bd91955985b1d59481b1a5cdd60521b6044820152606401610479565b6104b16040518060400160405280866000015181526020018660200151815250611b6a565b60405162461bcd60e51b8152602060048201526011602482015270626164205f6765744e6f646556616c756560781b6044820152606401610479565b6020818101518251600092111561027c5782516020036101000a60001901191692915050565b600060ff82811690600884811c80831692601087901c811692601888811c909216928792849261ff00909216916112a991908b901b62ff000016908b901b63ff000000166136a5565b6112b391906136a5565b6112bd91906136a5565b979650505050505050565b604080518082018252606080825260208201819052825160028082529181019093529091600091816020015b60608152602001906001900390816112f45790505090506000611318856001612067565b905061132b61132682612147565b612251565b8260008151811061133e5761133e613622565b602002602001018190525061135284612251565b8260018151811061136557611365613622565b60200260200101819052506105398261231d565b60608260008761138a60018961360b565b8151811061139a5761139a613622565b6020026020010151905060006113af82612361565b6040805160038082526080820190925291925060009190816020015b60408051808201909152606080825260208201528152602001906001900390816113cb579050509050600080600284600281111561140b5761140b6136fb565b14156115035760008b156114bf5760005b61142760018e61360b565b8110156114bd5760006114528f838151811061144557611445613622565b6020026020010151612361565b6002811115611463576114636136fb565b141561147b5781611473816136bd565b9250506114ab565b61149d8e828151811061149057611490613622565b602002602001015161243f565b516114a890836136a5565b91505b806114b5816136bd565b91505061141c565b505b60006114ce610d0c8d84611c4a565b905060006114db8861243f565b905080516114e98284611ca1565b1480156114f557508851155b156114ff57600193505b5050505b801561154a5761151b6115158661243f565b896112c8565b83838151811061152d5761152d613622565b60209081029190910101526115436001836136a5565b91506117d9565b600084600281111561155e5761155e6136fb565b14156115b05785516115745761151b8589612452565b8483838151811061158757611587613622565b602090810291909101015261159d6001836136a5565b915061151b611515610d0c886001611c4a565b8c60006115bc8761243f565b905060006115ca828a611ca1565b905080156116445760006115e3610d0c84600085611b25565b90506115fa816115f3868f6124d6565b6001612532565b87878151811061160c5761160c613622565b60209081029190910101526116226001876136a5565b9550611631610d0c8484611c4a565b9250611640610d0c8b84611c4a565b9950505b600061164e612616565b90508251600014156116735761166c816116678b6110e8565b612452565b9050611722565b60008360008151811061168857611688613622565b016020015160f81c90506116a0610d0c856001611c4a565b935060028960028111156116b6576116b66136fb565b14156116f25760006116d0856116cb8d6110e8565b6112c8565b90506116ea83836116e58985600001516124d6565b6126ec565b925050611720565b83511561170f5760006116d0856117088d6110e8565b6000612532565b61171d82826116e58d6110e8565b91505b505b895161176457611732818d612452565b90508087878151811061174757611747613622565b602090810291909101015261175d6001876136a5565b95506117d4565b611772610d0c8b6001611c4a565b99508087878151811061178757611787613622565b602090810291909101015261179d6001876136a5565b95506117a98a8d6112c8565b8787815181106117bb576117bb613622565b60209081029190910101526117d16001876136a5565b95505b505050505b6117ef8c6117e860018e61360b565b8585612776565b9d9c50505050505050505050505050565b600061181f604051806040016040528060608152602001606081525090565b83516000906060905b80156119a1578661183a60018361360b565b8151811061184a5761184a613622565b6020026020010151935061185d84612361565b92506002836002811115611873576118736136fb565b14156118aa5760006118848561243f565b90506118a2610d0c88600084518b5161189d919061360b565b611b25565b96505061197f565b60018360028111156118be576118be6136fb565b14156119055760006118cf8561243f565b90506118e8610d0c88600084518b5161189d919061360b565b8351909750156118ff576118fc85846128a4565b94505b5061197f565b6000836002811115611919576119196136fb565b141561197f5781511561197f5760008660018851611937919061360b565b8151811061194757611947613622565b602001015160f81c60f81b60f81c905061196e610d0c88600060018b5161189d919061360b565b965061197b8582856126ec565b9450505b61198d8885600001516124d6565b91508061199981613711565b915050611828565b508251805160208083019182206000818152918b90526040909120925190926119cb929091613315565b50979650505050505050565b604080518082019091526060808252602082015260008281526020849052604081208054611a0490613728565b80601f0160208091040260200160405190810160405280929190818152602001828054611a3090613728565b8015611a7d5780601f10611a5257610100808354040283529160200191611a7d565b820191906000526020600020905b815481529060010190602001808311611a6057829003601f168201915b50505050509050805160001415611ac7576000611aba84604051602001611aa691815260200190565b604051602081830303815290604052612968565b8051909150602082018181fd5b805160208201208314611b1c5760405162461bcd60e51b815260206004820152601760248201527f626164206861736820696e2074726965206c6f6f6b75700000000000000000006044820152606401610479565b61029081611bd3565b604080518082018252600080825260208083018290528351808501855282815281019190915282518084019093528551835285810190830152906102909084846129c0565b60606000826000015167ffffffffffffffff811115611b8b57611b8b613657565b6040519080825280601f01601f191660200182016040528015611bb5576020820181803683370190505b5090506000602082019050610bf68185602001518660000151612a3f565b60408051808201909152606080825260208201526040518060400160405280838152602001611c0184612aba565b905292915050565b6000806060602084600001511015611c2b57611c2484611b6a565b9050611c37565b611c3484612aed565b90505b611c408161123a565b9351939492505050565b6040805180820190915260008082526020820152610279838384865161189d919061360b565b606061027c611c9c8360200151600081518110611c8f57611c8f613622565b6020026020010151612aed565b610ac2565b6000805b808451118015611cb55750808351115b8015611d065750828181518110611cce57611cce613622565b602001015160f81c60f81b6001600160f81b031916848281518110611cf557611cf5613622565b01602001516001600160f81b031916145b156102795780611d15816136bd565b915050611ca5565b600080600080846000015111611d755760405162461bcd60e51b815260206004820152601860248201527f524c50206974656d2063616e6e6f74206265206e756c6c2e00000000000000006044820152606401610479565b6020840151805160001a607f8111611d9a576000600160009450945094505050612060565b60b78111611e16576000611daf60808361360b565b905080876000015111611e045760405162461bcd60e51b815260206004820152601960248201527f496e76616c696420524c502073686f727420737472696e672e000000000000006044820152606401610479565b60019550935060009250612060915050565b60bf8111611f05576000611e2b60b78361360b565b905080876000015111611e805760405162461bcd60e51b815260206004820152601f60248201527f496e76616c696420524c50206c6f6e6720737472696e67206c656e6774682e006044820152606401610479565b600183015160208290036101000a9004611e9a81836136a5565b885111611ee95760405162461bcd60e51b815260206004820152601860248201527f496e76616c696420524c50206c6f6e6720737472696e672e00000000000000006044820152606401610479565b611ef48260016136a5565b965094506000935061206092505050565b60f78111611f80576000611f1a60c08361360b565b905080876000015111611f6f5760405162461bcd60e51b815260206004820152601760248201527f496e76616c696420524c502073686f7274206c6973742e0000000000000000006044820152606401610479565b600195509350849250612060915050565b6000611f8d60f78361360b565b905080876000015111611fe25760405162461bcd60e51b815260206004820152601d60248201527f496e76616c696420524c50206c6f6e67206c697374206c656e6774682e0000006044820152606401610479565b600183015160208290036101000a9004611ffc81836136a5565b8851116120445760405162461bcd60e51b815260206004820152601660248201527524b73b30b634b210292628103637b733903634b9ba1760511b6044820152606401610479565b61204f8260016136a5565b965094506001935061206092505050565b9193909250565b606060008261207757600061207a565b60025b905060006002855161208c9190613763565b9050600061209b8260026136d8565b60ff1667ffffffffffffffff8111156120b6576120b6613657565b6040519080825280601f01601f1916602001820160405280156120e0576020820181803683370190505b5090506120ed8284613777565b60f81b8160008151811061210357612103613622565b60200101906001600160f81b031916908160001a905350808660405160200161212d9291906137cc565b604051602081830303815290604052935050505092915050565b606060006002835161215991906137f2565b67ffffffffffffffff81111561217157612171613657565b6040519080825280601f01601f19166020018201604052801561219b576020820181803683370190505b50905060005b8151811015610bf657836121b6826002613638565b6121c19060016136a5565b815181106121d1576121d1613622565b01602001516001600160f81b0319166004856121ee846002613638565b815181106121fe576121fe613622565b602001015160f81c60f81b6001600160f81b031916901b1782828151811061222857612228613622565b60200101906001600160f81b031916908160001a90535080612249816136bd565b9150506121a1565b6060808251600014156122b15760408051600180825281830190925290602082018180368337019050509050608060f81b8160008151811061229557612295613622565b60200101906001600160f81b031916908160001a90535061027c565b825160011480156122dc57506080836000815181106122d2576122d2613622565b016020015160f81c105b156122e857508161027c565b6122f483516080612b89565b836040516020016123069291906137cc565b604051602081830303815290604052905092915050565b6040805180820190915260608082526020820152600061233c83612d38565b9050604051806040016040528082815260200161235883612aba565b90529392505050565b600061236f601060016136a5565b826020015151141561238357506000919050565b6002826020015151141561240357600061239c83611c70565b90506000816000815181106123b3576123b3613622565b016020015160f81c905060028114806123cf575060ff81166003145b156123de575060029392505050565b60ff811615806123f1575060ff81166001145b15612400575060019392505050565b50505b60405162461bcd60e51b8152602060048201526011602482015270496e76616c6964206e6f6465207479706560781b6044820152606401610479565b606061027c61244d83611c70565b612d7c565b6040805180820190915260608082526020820152600061247183612251565b604080518082018252600080825260209182015281518083019092528251825280830190820152909150602085015180516124ae9060019061360b565b815181106124be576124be613622565b60200260200101819052506102908460200151612dc8565b60606020825110156124e957508061027c565b8151602080840191822060008181529186905260409091208451919261250e92613315565b5060408051602081018390520160405160208183030381529060405291505061027c565b604080518082018252606080825260208201819052825160028082529181019093529091600091816020015b606081526020019060019003908161255e5790505090506000612582866000612067565b905061259061132682612147565b826000815181106125a3576125a3613622565b6020026020010181905250602085511015806125bc5750835b156125ed576125ca85612251565b826001815181106125dd576125dd613622565b602002602001018190525061260d565b848260018151811061260157612601613622565b60200260200101819052505b6104b18261231d565b60408051808201909152606080825260208201526000612638601060016136a5565b67ffffffffffffffff81111561265057612650613657565b60405190808252806020026020018201604052801561268357816020015b606081526020019060019003908161266e5790505b50905060005b81518110156126dc57604051806040016040528060018152602001600160ff1b8152508282815181106126be576126be613622565b602002602001018190525080806126d4906136bd565b915050612689565b506126e68161231d565b91505090565b6040805180820190915260608082526020820152600060208351106127195761271483612251565b61271b565b825b60408051808201825260008082526020918201528151808301909252825182528083019082015290915085602001518560ff168151811061275e5761275e613622565b60200260200101819052506105398560200151612dc8565b6060600061278483866136a5565b67ffffffffffffffff81111561279c5761279c613657565b6040519080825280602002602001820160405280156127e157816020015b60408051808201909152606080825260208201528152602001906001900390816127ba5790505b50905060005b858110156128395786818151811061280157612801613622565b602002602001015182828151811061281b5761281b613622565b60200260200101819052508080612831906136bd565b9150506127e7565b5060005b8381101561289a5784818151811061285757612857613622565b602002602001015182878361286c91906136a5565b8151811061287c5761287c613622565b60200260200101819052508080612892906136bd565b91505061283d565b5095945050505050565b604080518082018252606080825260208201819052825160028082529181019093529091600091816020015b60608152602001906001900390816128d057905050905060006128fc6128f58661243f565b6000612067565b905061290a61132682612147565b8260008151811061291d5761291d613622565b602002602001018190525060208451101561295657838260018151811061294657612946613622565b602002602001018190525061295f565b61135284612251565b6105398261231d565b6060600061297583612e96565b90506308c379a08160405160240161298d9190613806565b60408051601f198184030181529190526020810180516001600160e01b031660e09390931b929092179091529392505050565b60408051808201909152600080825260208201526129de82846136a5565b84511015612a145760405162461bcd60e51b815260206004820152600360248201526237b7b160e91b6044820152606401610479565b6040518060400160405280838152602001848660200151612a3591906136a5565b9052949350505050565b60208110612a775781518352612a566020846136a5565b9250612a636020836136a5565b9150612a7060208261360b565b9050612a3f565b80612a8157505050565b60006001612a9083602061360b565b612a9c9061010061391d565b612aa6919061360b565b925184518416931916929092179092525050565b60408051808201825260008082526020918201528151808301909252825182528083019082015260609061027c90612f9c565b60606000806000612afd85611d1d565b919450925090506000816001811115612b1857612b186136fb565b14612b655760405162461bcd60e51b815260206004820152601860248201527f496e76616c696420524c502062797465732076616c75652e00000000000000006044820152606401610479565b610539604051806040016040528084815260200185886020015161116e91906136a5565b6060806038841015612bf05760408051600180825281830190925290602082018180368337019050509050612bbe83856136a5565b60f81b81600081518110612bd457612bd4613622565b60200101906001600160f81b031916908160001a905350610279565b600060015b612bff81876137f2565b15612c255781612c0e816136bd565b9250612c1e905061010082613638565b9050612bf5565b612c308260016136a5565b67ffffffffffffffff811115612c4857612c48613657565b6040519080825280601f01601f191660200182016040528015612c72576020820181803683370190505b509250612c7f85836136a5565b612c8a9060376136a5565b60f81b83600081518110612ca057612ca0613622565b60200101906001600160f81b031916908160001a905350600190505b818111612d2e57610100612cd0828461360b565b612cdc9061010061391d565b612ce690886137f2565b612cf09190613763565b60f81b838281518110612d0557612d05613622565b60200101906001600160f81b031916908160001a90535080612d26816136bd565b915050612cbc565b5050905092915050565b60606000612d45836131e3565b9050612d53815160c0612b89565b81604051602001612d659291906137cc565b604051602081830303815290604052915050919050565b6060600282600081518110612d9357612d93613622565b0160200151612da5919060f81c613683565b60ff16612dba5761027c610d0c836002611c4a565b61027c610d0c836001611c4a565b60408051808201909152606080825260208201526000825167ffffffffffffffff811115612df857612df8613657565b604051908082528060200260200182016040528015612e2b57816020015b6060815260200190600190039081612e165790505b50905060005b8351811015612e8c57612e5c848281518110612e4f57612e4f613622565b6020026020010151611b6a565b828281518110612e6e57612e6e613622565b60200260200101819052508080612e84906136bd565b915050612e31565b506109798161231d565b60606000612ea383610ac2565b905060005b8151811015610bf6578151600560f91b90839083908110612ecb57612ecb613622565b01602001516001600160f81b0319161015612f37576030828281518110612ef457612ef4613622565b0160200151612f06919060f81c613777565b60f81b828281518110612f1b57612f1b613622565b60200101906001600160f81b031916908160001a905350612f8a565b6057828281518110612f4b57612f4b613622565b0160200151612f5d919060f81c613777565b60f81b828281518110612f7257612f72613622565b60200101906001600160f81b031916908160001a9053505b80612f94816136bd565b915050612ea8565b60606000806000612fac85611d1d565b919450925090506001816001811115612fc757612fc76136fb565b146130145760405162461bcd60e51b815260206004820152601760248201527f496e76616c696420524c50206c6973742076616c75652e0000000000000000006044820152606401610479565b6040805160208082526104208201909252600091816020015b604080518082019091526000808252602082015281526020019060019003908161302d5750508651909150600090859061306786836136a5565b146130b45760405162461bcd60e51b815260206004820181905260248201527f50726f766964656420524c50204c697374206e6f7420636f6e73697374656e746044820152606401610479565b87518110156131d7576020821061311f5760405162461bcd60e51b815260206004820152602960248201527f50726f766964656420524c50206c6973742065786365656473206d6178206c696044820152680e6e840d8cadccee8d60bb1b6064820152608401610479565b60008061315c6040518060400160405280858d60000151613140919061360b565b8152602001858d6020015161315591906136a5565b9052611d1d565b50915091506040518060400160405280838361317891906136a5565b8152602001848c6020015161318d91906136a5565b8152508585815181106131a2576131a2613622565b60209081029190910101526131b86001856136a5565b93506131c481836136a5565b6131ce90846136a5565b925050506130b4565b50815295945050505050565b6060815160001415613205576040805160008082526020820190925290610bf6565b6000805b835181101561324c5783818151811061322457613224613622565b6020026020010151518261323891906136a5565b915080613244816136bd565b915050613209565b60008267ffffffffffffffff81111561326757613267613657565b6040519080825280601f01601f191660200182016040528015613291576020820181803683370190505b50600092509050602081015b85518310156105ba5760008684815181106132ba576132ba613622565b6020026020010151905060006020820190506132d883828451612a3f565b8785815181106132ea576132ea613622565b602002602001015151836132fe91906136a5565b92505050828061330d906136bd565b93505061329d565b82805461332190613728565b90600052602060002090601f0160209004810192826133435760008555613389565b82601f1061335c57805160ff1916838001178555613389565b82800160010185558215613389579182015b8281111561338957825182559160200191906001019061336e565b50613395929150613399565b5090565b5b80821115613395576000815560010161339a565b63ffffffff811681146133c057600080fd5b50565b600080604083850312156133d657600080fd5b8235915060208301356133e8816133ae565b809150509250929050565b60008060006060848603121561340857600080fd5b83359250602084013561341a816133ae565b915060408401356001600160f81b03198116811461343757600080fd5b809150509250925092565b60008060006060848603121561345757600080fd5b833592506020840135613469816133ae565b91506040840135613437816133ae565b6001600160e01b0319811681146133c057600080fd5b6000806000606084860312156134a457600080fd5b8335925060208401356134b6816133ae565b9150604084013561343781613479565b6000806000606084860312156134db57600080fd5b8335925060208401356134ed816133ae565b929592945050506040919091013590565b60008060006060848603121561351357600080fd5b833592506020840135613525816133ae565b915060408401356001600160f01b03198116811461343757600080fd5b60006020828403121561355457600080fd5b8151610279816133ae565b60006020828403121561357157600080fd5b815161027981613479565b634e487b7160e01b600052601160045260246000fd5b600063ffffffff838116908316818110156135af576135af61357c565b039392505050565b600063ffffffff808316818516818304811182151516156135da576135da61357c565b02949350505050565b600063ffffffff8083168185168083038211156136025761360261357c565b01949350505050565b60008282101561361d5761361d61357c565b500390565b634e487b7160e01b600052603260045260246000fd5b60008160001904831182151516156136525761365261357c565b500290565b634e487b7160e01b600052604160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b600060ff8316806136965761369661366d565b8060ff84160691505092915050565b600082198211156136b8576136b861357c565b500190565b60006000198214156136d1576136d161357c565b5060010190565b600060ff821660ff8416808210156136f2576136f261357c565b90039392505050565b634e487b7160e01b600052602160045260246000fd5b6000816137205761372061357c565b506000190190565b600181811c9082168061373c57607f821691505b6020821081141561375d57634e487b7160e01b600052602260045260246000fd5b50919050565b6000826137725761377261366d565b500690565b600060ff821660ff84168060ff038211156137945761379461357c565b019392505050565b60005b838110156137b757818101518382015260200161379f565b838111156137c6576000848401525b50505050565b600083516137de81846020880161379c565b83519083019061360281836020880161379c565b6000826138015761380161366d565b500490565b602081526000825180602084015261382581604085016020870161379c565b601f01601f19169190910160400192915050565b600181815b8085111561387457816000190482111561385a5761385a61357c565b8085161561386757918102915b93841c939080029061383e565b509250929050565b60008261388b5750600161027c565b816138985750600061027c565b81600181146138ae57600281146138b8576138d4565b600191505061027c565b60ff8411156138c9576138c961357c565b50506001821b61027c565b5060208310610133831016604e8410600b84101617156138f7575081810a61027c565b6139018383613839565b80600019048211156139155761391561357c565b029392505050565b6000610279838361387c56fea2646970667358221220d847ed8e0f313371c61fcce4ff36fe389d0fa295e6c5584ba30dd6d68f94f93164736f6c634300080b0033")
	if err != nil {
		panic(err)
	}
}

func TestRV32I(t *testing.T) {
	tests, err := filepath.Glob("test_case/isa/rv32ui-v-*")
	if err != nil {
		t.Fatal(err)
	}
	for _, f := range tests {
		t.Run(f, func(t *testing.T) {
			image, entry := GetImageWithEntrypoint(f)
			if len(image)&3 != 0 {
				panic("wrong image")
			}
			m := make(map[uint32]uint32)
			for i := uint32(0); i < uint32(len(image)); i += 4 {
				m[i] = binary.LittleEndian.Uint32(image[i : i+4])
			}
			ret, err := start(m, entry)
			if err != nil {
				t.Log(err)
				r, _ := web3.DecodeRevert(ret)
				t.Fatal("revert: ", r)
			}
		})
	}

}

func start(ram map[uint32]uint32, entrypoint uint32) ([]byte, error) {
	this := newCase()
	if ret, err := this.copyRam(ram); err != nil {
		return ret, err
	}
	return this.start(entrypoint)
}

type testCase struct {
	evm *vm.EVM
	//interpreter contract bi
	rvAbi *abi.ABI
	//interpreter contract addr
	rvAddr common.Address
	//machine state abi
	ramAbi *abi.ABI
	//machine state addr
	ramAddr common.Address
	ramTrie *trie.Trie
	sender  vm.AccountRef
}

func newCase() *testCase {
	//get contract artifact
	ars, err := hardhat.GetArtifact("Interpretor", "out")
	if err != nil {
		panic(err)
	}

	rvAbi, err := abi.NewABI(ars.Abi)
	if err != nil {
		panic(err)
	}

	ars2, err := hardhat.GetArtifact("MachineState", "out")
	if err != nil {
		panic(err)
	}
	ramAbi, err := abi.NewABI(ars2.Abi)
	if err != nil {
		panic(err)

	}
	ramAddr := common.BytesToAddress([]byte("MachineState"))
	vmevm := tests.NewEVMWithCode(map[common.Address][]byte{ramAddr: ars2.DeployedBytecode})
	sender := vm.AccountRef(common.BytesToAddress([]byte("test")))
	trie, err := trie.New(common.Hash{}, trie.NewDatabase(memorydb.New()))
	if err != nil {
		panic(err)
	}
	//constructor(address state)
	input := rvAbi.Constructor.MustEncodeIDAndInput(ramAddr)
	_, rvAddr, _, err := vmevm.Create(sender, append(ars.Bytecode, input...), math.MaxUint64, new(big.Int))
	if err != nil {
		panic(err)
	}
	return &testCase{vmevm, rvAbi, rvAddr, ramAbi, ramAddr, trie, sender}
}

func (this *testCase) newInterpretor() {
}

//copy ram to evm
func (this *testCase) copyRam(ram map[uint32]uint32) ([]byte, error) {
	for k, v := range ram {
		ret, err := this.writeMemory(k, v)
		if err != nil {
			return ret, err
		}
	}
	return nil, nil
}

func (this *testCase) writeMemory(k, v uint32) (ret []byte, err error) {
	//function writeMemory(
	//        bytes32 root,
	//        uint32 ptr,
	//        uint32 value
	//    ) public returns (bytes32)
	input := this.ramAbi.Methods["writeMemory"].MustEncodeIDAndInput(this.ramTrie.Hash(), k, v)
	kk, vv := make([]byte, 4), make([]byte, 4)
	//key is big endian
	binary.BigEndian.PutUint32(kk[:], k)
	//v is little endian
	binary.LittleEndian.PutUint32(vv[:], v)
	this.ramTrie.Update(kk, vv)
	ret, _, err = this.evm.Call(this.sender, this.ramAddr, input, math.MaxUint64, new(big.Int))
	return
}

func (this *testCase) start(entrypoint uint32) (ret []byte, err error) {
	// function start(uint32 _entrypoint) public
	input := this.rvAbi.Methods["start"].MustEncodeIDAndInput(entrypoint)
	ret, _, err = this.evm.Call(this.sender, this.rvAddr, input, math.MaxUint64, new(big.Int))
	return
}

// SPDX-License-Identifier: GPL-v3
pragma solidity ^0.8.0;

import "../test-helper/TestBase.sol";
import "./StateTransition.sol";

contract TestStateTransition is TestBase, StateTransition {
    function setUp() public {
        mstate = IMachineState(new MachineState());
        interpretor = new Interpretor();
        interpretor.initialize(address(mstate));
        imageStateRoot = hex"2ead174930137579e36ccc4d9b5d89c3ad532188617d6f74ed97a5e0c94f90b7";

        mstate.insertPreimage(
            hex"f90131a0a0bac0dc18f9e3e216396a0eb6cff18a51b27f4d0388b4385ebcbf0c9a95bc5ea0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba006cc4007138b03ff4c2e923898479be7fccb68f4ad7b9d7d16c2ec08cfd58c508080808080808080"
        );
        mstate.insertPreimage(
            hex"f86380a08ed1907384960947f47c788d7ba0dbdd27d786b917d9efc4ff35ce134070a78ea08ed1907384960947f47c788d7ba0dbdd27d786b917d9efc4ff35ce134070a78e8080c6208400000000808080c6208400000000808080c6208400000000808080"
        );
        mstate.insertPreimage(hex"e220a00000000000000000000000000000000000000000000000000000000000000000");
        mstate.insertPreimage(hex"e4820000a073f870ae4a7fc761c11712113db2b14860b934f7becd2e88ce14d9886990ca2c");
        mstate.insertPreimage(
            hex"f851a0af2b792e00cdd8e409d30a4b3c61302ea27872df513d06656256a36e5d726d52a09d6631b653a4d2e801394c7edeaf75a5fd217b9429ad862c62c94557f31888c2808080808080808080808080808080"
        );
        mstate.insertPreimage(
            hex"f90211a0af389ec3d8fcdc20e15ee5943d60fa9a9a41232673c274ef640671ff145caea7a08c0e4b3994cc87e648c38331dc58101c76f41010fc6b9be34083b69d4df42fa6a02b3c699f96aa75ab32b5edff5d6e467a455e6a33c0354940fcd5eeacf7c01cb4a0b4506b4e162bfb5b63116596ba7f066633b2ffdafc22d6deb25f1516ddb0a0c1a04467e9351c5b53bf70ef30c05fc42c354a0c46c49521473bfc27f401b31476a8a01ac5de38b9807a025bfebe197e795bccd556d860cf7560202e79926b69be6675a02b10cc67152a578e9b1a576925adf3b1f2a5e7d0d007811786d5c30e10049158a0fcf3d9904d488e81d9409260eab5fcbc0c3cb2ecd7e6fa26a05a8baf15f3a489a084bae22f2e2c5fbb6cc0cc0c6ab17c29d02123650eb3bd63df7094aa99d5735aa0b3720f994b9c76beddfbc0aa2ca6f6b9ab4ba2e3fe11b65adf0c99000dd9d5eea02eeb98d784826a61334bcc84b60fc522e79ec422b9ff0ed992f7c110b33a88f9a0044df6a41c5b489c695cd1931f28f1cefe7f487dd5ec323ecbb79d3ea6715c70a059d48b3c51b46bcdf87b7e945d8344b36cd154213084b8265fbbdca4bcae0d80a046b2d8fd91575afb33f0ae93c1a802c32b2a56ee3f20b4ff3b6e833d56a40408a0d690f315efe6c3270e0f71d5b7e010ed42691014d9927c27ebb5f0a2ba4a1361a048d1e12b45fe481fe8f1e096e683334a542efde9aa635cf8fce8c3d25424e9de80"
        );
        mstate.insertPreimage(hex"e4820000a026d12d91d1b237b9c056f21e453014b7a34934701e539d6638db36c314a63ec7");
        // exec one step data
        mstate.insertPreimage(
            hex"f8d1a064e31f3b28affa0ddc9ccec26977a7123c92be6dcf5025e428c544e65cc143b1a0318e798d7ce861c8a9e355ad0fb6c6f618334ae90595f798a4ed48bda08a1b83a0e868439c549003b3f2ef372de2721b647493876076f6f1c28a74ff575799d88380a0c900bab1560390bcf2e06389862ace9a841cca3c7531a4d5ef44ce3c7e05c6c1a094836146c935bee12cc1cd2738d547a05a7c3083b4de872a6912cf6cdbb9f047808080808080808080a0b2ae72af3ba657f8362844a8a298592d367e9246797d18bca9c4f20bc1eb52dc80"
        );
        mstate.insertPreimage(
            hex"e980c620841c000000808080c62084000074a5808080c62084a5000000808080c6208474000000808080"
        );
        mstate.insertPreimage(
            hex"e9c6208413050100808080c6208473000000808080c62084130a0500808080c620840325440080808080"
        );
        mstate.insertPreimage(hex"e4821fffa021a087937b798c1d9c174c12a7e5816708ca5f20d23a4f3515e3f6010fc16049");
        mstate.insertPreimage(
            hex"f9015780808080c63c8400000000a09288bf715859812cac44adfa51c0e456365af2da9b541940e6bca0bc70ecd78fa094d5802234d1980a4a234260d97de09d566a810b64d2832ba78458dcca0126a3a051284da48f421efa7ad73fb5214f372e24fd19654ce3830037bb1d6701f1aa54a08bda357bbf3bfe5faaf4a96a59db92df5397139c13a007f7c1ffcac4eb081449a0d1ca628e2da61fc39a8790a53b1914337859d224a29e02eae9d03fbf22102b49a056076685af84ae4a8bd1019c378b7b69129b40d67a4b2bab6a5731d3fa1d7548a0ffbb1ba3ded6c0c24b2a8fb50b6dd654b7486c8349cee1acf0f6150891536661a04065f864eab17b0ed3b6e0ef9e52087433968ea75bae66505581018503953267a0cc61c5bf94706c350188ccda27baf4959d52efb0b1acdac0eab3282d790b2ad9a0e3257675cf853b45b703664659f3314ccb29104a04bd25fbaa7bc481e47d39848080"
        );
        mstate.insertPreimage(hex"e4820000a0b6d89e7fd15745f725829b40b162e5b3dbdf99e312ac06207800012fcc1bab42");
        mstate.insertPreimage(
            hex"e980c6208410000000808080c6208418eaffff808080c6208410f4ffff808080c62084b0e8ffff808080"
        );
        mstate.insertPreimage(
            hex"e9c62084c768cb87808080c620842dc1caf8808080c62084e5719cf5808080c62084d4b54ea980808080"
        );
        mstate.insertPreimage(
            hex"f90211a00835005040623746a40248995343341d5127100b29bbc3becef4e22dc37b8dc8a09a675080308cb45fe411482d51a749d7654c2711b2bf1fcf26a3175045935603a0a7e61a204907c6f37c11e49c10d03045b575db6680180cd0f14801706eeb7574a06541380669d9dc71dd5ffe688334d80c05e80a727b36dac6f9a3a2b769965abba08fb4111fac825ba02644c92609e93e4161cc27e3a4d11cc969e4b97f235f6604a0902fd45473a119d53da0a8ebe496070f07be8ce821015d93480983aaebacd37da0d6b71be832bf17ce9f2f9328797894dc6523bd7e245993d6510b0957efc05952a066b770a5418beecb372b3826ba2d65fb8fd4bb905e3683badc143ec6e89a83d7a0032771a7018673b006fcf65f134c9273b59bedce4e2a8c3ca39fc5f5a5e9ef88a09c16a13a4e1dcabb3326e59ef238f4daf437480c8e255c7e7e1fb8700eb1aa91a0b5dba499fa364c67a06ad7a4152d6812c79b7a28125d1163954d05ad28279f0ba0cd59dfa61625a503b93ccd7e348535cc0a992e999baf88f3375cfce3d0950338a04801cd6cf68bc810da869b07e6b3bbd867c56643ac42ab92c6c860fc2d3d51d6a0b98009a3a20c1d592a2d0fb1355001ea786360f777e39ed5c879850fe367c5b9a027af6316e269bff3f868879fc83acd573963bb4fa776e6d9150712f661c69e3ca0989b09e5e812f1efd481884b3e6d25093d2f33b139c3786d22915c6a89e9b4d280"
        );
        mstate.insertPreimage(
            hex"f90211a09dac717b0c397475525b5ca01b3a154ed8305f82250207f481fbdba5fde714b9a08c0e4b3994cc87e648c38331dc58101c76f41010fc6b9be34083b69d4df42fa6a02b3c699f96aa75ab32b5edff5d6e467a455e6a33c0354940fcd5eeacf7c01cb4a0b4506b4e162bfb5b63116596ba7f066633b2ffdafc22d6deb25f1516ddb0a0c1a04467e9351c5b53bf70ef30c05fc42c354a0c46c49521473bfc27f401b31476a8a01ac5de38b9807a025bfebe197e795bccd556d860cf7560202e79926b69be6675a02b10cc67152a578e9b1a576925adf3b1f2a5e7d0d007811786d5c30e10049158a0fcf3d9904d488e81d9409260eab5fcbc0c3cb2ecd7e6fa26a05a8baf15f3a489a084bae22f2e2c5fbb6cc0cc0c6ab17c29d02123650eb3bd63df7094aa99d5735aa0b3720f994b9c76beddfbc0aa2ca6f6b9ab4ba2e3fe11b65adf0c99000dd9d5eea02eeb98d784826a61334bcc84b60fc522e79ec422b9ff0ed992f7c110b33a88f9a0044df6a41c5b489c695cd1931f28f1cefe7f487dd5ec323ecbb79d3ea6715c70a059d48b3c51b46bcdf87b7e945d8344b36cd154213084b8265fbbdca4bcae0d80a046b2d8fd91575afb33f0ae93c1a802c32b2a56ee3f20b4ff3b6e833d56a40408a0d690f315efe6c3270e0f71d5b7e010ed42691014d9927c27ebb5f0a2ba4a1361a048d1e12b45fe481fe8f1e096e683334a542efde9aa635cf8fce8c3d25424e9de80"
        );
        mstate.insertPreimage(
            hex"f90131a0c093f0f9ea6412e08e07a04a46a98ba7c5ef2596fe20eff275e820eca5b07be2a090c036c7f8a8a5be9d4a43598c7cab59fee6f9700b6f2d17c7b7d78d2ae5e45fa07ed4354665863fbd88e8f8650baa5b9741ff0422c321b7b281894cec687a19e8a0ec939dff12c6c391301f7c87625d46b078fb0db9eb590c62504b507de8066873a0eb23268a5e3b418ccf42f7dea7887a6bf8452742f98a38877f8de0e415071a5ca03a0ce367e0cb6ef9b70897f6eeb50530b1b37eed0c937d95db0fc7a5ac35c47ea0880dae613030a479281aad645817d4d6b6e467bc28c3ca706bf3aebe2b1440cba0827e536d31232a730a50d3da07824fa1e11c688c69c710fd3c35084a35e1ecf1a0aedb99caf8da134feed8f8631e197650012ac37309f241ecc03fbb6abf8397288080808080808080"
        );
        mstate.insertPreimage(hex"e380c62084ebeb9320808080c62084b44b0f00808080c620840000000080808080808080");
        mstate.insertPreimage(
            hex"f8718080808080808080a0f3cd72983562b25883153e3575c9d5211c21d5314f795bc5611436445c5ab97ea0b4e871e945e3dd4ca01c9fd4659d612723e8f374d1ada4bbc62eae4c28f2bf6ea0bfa613d47d82e69184bba77180eb639c377a54a2a135f03bc7cc1fdc7b2029f6808080808080"
        );
        mstate.insertPreimage(
            hex"f8518080808080808080808080808080a06f043484ffa31da4754f71840605c81019c1c8888d0c5ff6a87faad57a4ff554a0149dc31ab398e7d8cc77b9c6c5b6cce79a3298d87cd45785db5119e377685ac180"
        );
        mstate.insertPreimage(
            hex"e9c62084dc8a74a5808080c620849f8f2a88808080c62084151adbd5808080c620845fed9a5280808080"
        );
        mstate.insertPreimage(
            hex"f86380a0c527efc33b27a918d6a7260ea1786f62dd88c2155592b537faa9f418e6ac57eba08ed1907384960947f47c788d7ba0dbdd27d786b917d9efc4ff35ce134070a78e8080c6208400000000808080c6208424480f00808080c62084b0e8ffff808080"
        );
        mstate.insertPreimage(
            hex"f90211a052a15bf3575d8b663192138c02dd8bee58cee033cbb23c99e5b14b9c1452dc64a0235f5823eeb9a9316d91c67682d0e90e8232ad9afdeec153f85b80a8ce24fd5aa0d21ce409d5655b0f79b5e86cbc13fa0c60573f03c328fce4b56371de744b7108a06766e3b854beecef74d35a8289c7625b13008ef7bdb4c7c3c334a5e5c03e0715a0a746dce3265be4ee97560856b08ad59e5a70f3ba5e45f4b19092826dc25b9462a0baddfd9d473107860cf964215853ccb72f5dc471af47910a44eeff40547c2015a0e6749bdd569834db5c71c841ce830333c33ce250b8dc99c8d6547ba48469ea84a0dbf45a81651cb47b52b17c1378206483efe8f329a048acf0ffcedda70cb62ba6a01e88128a9f3e0ae2f5058190b0c4d18a94d7ed591ae7ed09838a4420e2524ceea0ac0481b1b882238029711e8f795886f9df053d59049e99f1c8160bebc8947a0ba06baf73d7867e16b4692e072db68ce8585e5ddf6958b80b2e031711137ae1429fa0f59f4ac855739ad9f64df07813309d2f16bc9f6bc0cf4a8e45f70a02d9a1c4d5a055c99de49bf6880735f7903542c671a38bcca49639c9717fd915cb086ebf2373a0c8961121c3199309511aba344eabe64822f09946c94cbc6dcfce57c8992a4a54a0c4779b9ea4e401f9962ba6642a25778c297ff19999756632689d6da5da50e173a0b8652187aab0759c1d43c3feaaf518ad90ef580052f4ef602e9523cab61cd0be80"
        );
        mstate.insertPreimage(
            hex"e980c6208474000000808080c6208401000000808080c6208403000000808080c6208495000000808080"
        );
        mstate.insertPreimage(
            hex"f90211a006b4f3acde93f25af6fbd5c2c2ef4b06026f938558d58d46de917e087f317bf3a012646da6df184dd4914b8c865b1a1eee485670a61bc1e825065a31d73016e52ea0364014de8a3db900a4ac1f6e3603f88bea9186f79e026379d5126c32b648ef41a0eaadfb16e6af1fd084e7705a6238fb3d40b20f353ac6035cb7191320e243e26ca08e1961c516d25440cb029ea270485ebd7b74909dcb69f6d17989a171de17682fa0519b0f149ea5beaa530bae44b79f518c04fb0c093d953ed860f918349393e582a0039fba583c1746537d763467a6de03965392cf633270aa5655cfc5520f776401a0c2c6b684b04a4dd33044db83e9ce7ae131ba25c53836a263c975590982dd8699a02685467e3d58aee2d8599a0804860feddff5ea64460f4b7cd920f7fb0bebd10ea0121dc6da23cb9f9b87987e594408848ab226a3a55681df2720781e755a8f83b1a09a164a2b7b5289d14ed4255fba2d85c78b7247801549954b040423a3014477dea0ed57b35568993a6e1a5b78002fe209bd60b047fcbf385f1cbd21940353ad6cc3a04ce3925218ad8da8cf89691f8c603c7ee049537d598909c23b1685410332fad0a05646490177b5328e750b247321960e36ecbd8370a2c2161bfbaac13172f95f33a0f555c4c80acd49657252b6fea2a24d19b644da009dcb8bbd4536833573559d7da0f278bf2ff5e51bd1bc4b7bb7f6a21bc174e2b52f74b54c4c7f8bca1fe1fc795b80"
        );
        mstate.insertPreimage(
            hex"f90211a04b2338765cc2c3146f6e75f7b23b7c5708f7dcbbe51a4f8ddc203996b8b0bcfda0077952fd8da92c3cdee5d4972c8debdbe204f2f78f581d9641b1a6fb19e63904a06c9b9b3b3ab33264b85f43877a6dd6a536d3ded1c5791a585be4259d055982d1a0be24587dc1b8ff186b2ce399a18922fdf928a469499270cf57fafcb6e30f342ca0bac92856307f2d93778fe22ff381b000bf0a7431a2efea24855ce0b687f6e7b5a0f332b740308eca246476af6d59d46afdb15516fdc7af0f85a40e1dfb57172655a02fb353e2452cc713c567974b7acfaa1062a7bf556b8ac3ee6982dbc60cf5baefa03eed6d8825e492abe87feea4e4f67f1c6a5117dfec99b705322dabed9b27e3bea0fa8fa345f60cbcf398d09e9c93497541ef724cf28e946341d2ad6f5da1b824f2a06e5e2c10ee36143c04b6b876e5b2141577d73812cd1c2bd3ef63133ceac4e34ca0b3285d1720389cf2a127bfb46ca2f149086ace7f31199470c9acfd84359df401a01e704660450d0ff8cb649413a623790bfc6a9eb38d42de7a596f8036bfd8da86a08a34b7562b143160ccc5875ce8bde7bacca141c99de72098a8a5fea9f75dfa38a048560824f52cfb745369e52830a1b707af994cca31f38a2f23e96896ee5073c4a01178abceb8f8d0654dc4d9603c4688c7d0d35463e7ef72528a47a225f8803f2ba0a9a2c9a6e5cc66fb66ca95b33dec3b106adc9c88b5189a3f305f0144a9d44c6880"
        );
        mstate.insertPreimage(
            hex"f90211a0113a3897bc339871a8341faf96f048052e40b94df4ed72a7e4d28f43248c674da0554745bd84674d7e56c58dea04ca4a09ed403a8546ced5c48547e514d4a42574a09bd932cb2c913ec268f212c507cb0a1c57cd36d590e2a5bd27999c8c5277239ba07055614b22946d594c87413fbb397e33c3f991557b5bf9952ad261cd0c3ac23da046de31728ab156d12df9e9389e5ea96f8b5bc9c92556fcb555625004b625fa32a0d5bdd12b1fc82e71add265d5a1a4aa1063ad2b279adcd3e21c4b9420b2f166c6a0d5d888a33e6897206f9807810f0cea3780f77318152f3df9960f3d4528b0a2cda0244d1f39f91a6191eabdc2bc44df42b6171550ee191e98753a791d1741b0acc6a052da7824fc96bcf122cbdd97d417e6cb8e5aef888f0e7f1980ee179fe3e095b4a0734612384fd00f03b80815dc19794ef0675d83bffc28ee1f790a3ed57eeb3fa5a0f7dfaea1eaf0375b906872265306224e5674349e2cbfcfe246b91f602241a41fa02f7aba05451ef66d500df629beb3fca2e906b36631a34204d5589ad7db8a983ba0b820d28057622d89c3615c4bba3099aaa3c1bd469d7210e4b83371d550592f7fa084621a1c2d110c40fedc40db12d291fc5e36706055ab06bcc81ad16d07179bf6a0d12505575b1fd443f04e92bb9dc43a102f93fdefe3959a303ec300877e7a0f7da0adedc6454ab3e75a91888dc8172d3101a7a2298045314b82b87bba462525929c80"
        );
        mstate.insertPreimage(
            hex"000000000000000000000000000000010000000000000001000000006336671a00f872f870f86e80843b9aca00830585489430509858e5050e41bc2935230b624c336610de3588016345785d8a00008082aa3ca0f1a2a24e06df5be5b9f9675efbd4d315f47c1ea9e8bc09241cb8095b149063a2a012fbdf2077924eb74c4760164e3c0feee42368e5f1a92e73da9f4d4fab905413"
        );
    }

    function testSetInput() public {
        mstate.writeInput(imageStateRoot, hex"05ac5a0aa4c969438f363cdee683eb5901247a0d4b5e226ea538a89408f85728");
    }

    function testExecLastOneStep() public {
        bytes32 startState = hex"e0ea6d045f6438042ab2f3a22e76b9b91af4b2178eb0e990887b57b2f718846a";
        bytes32 endState = hex"44c7258402f2916e9f25bb2cb09f8044160e39bc47250f5bc0593a5e05d8df43";
        (bytes32 nextStateHash, ) = interpretor.step(startState);
        require(endState != nextStateHash, "consistent end state");
    }
}
